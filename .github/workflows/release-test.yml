name: Release Test

on:
  workflow_dispatch:
  push:
    branches: [feature/release-binaries]
    paths:
      - 'test-notarize/**'
      - '.github/workflows/release-test.yml'
      - 'build/sign.js'
      - 'build/entitlements.mac.plist'

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-14
    defaults:
      run:
        working-directory: test-notarize

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # Use apple-actions for clean keychain setup (works well for import,
      # even though electron-builder's @electron/osx-sign hangs with it)
      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MAC_CERTS }}
          p12-password: ${{ secrets.MAC_CERTS_PASSWORD }}

      - name: Extract signing identity
        id: identity
        run: |
          # Find the Developer ID Application identity from the keychain
          IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1)
          echo "Full identity line: $IDENTITY"

          HASH=$(echo "$IDENTITY" | awk '{print $2}')
          NAME=$(echo "$IDENTITY" | sed 's/.*"\(.*\)".*/\1/')
          echo "Identity hash: $HASH"
          echo "Identity name: $NAME"

          if [ -z "$HASH" ]; then
            echo "::error::No Developer ID Application certificate found in keychain"
            security find-identity -v -p codesigning
            exit 1
          fi

          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm install

      - name: Build and sign
        run: npx electron-builder --mac --publish never
        timeout-minutes: 10
        env:
          # Custom sign.js reads these directly (paths relative to working-directory)
          CSC_NAME: ${{ steps.identity.outputs.hash }}
          CSC_ENTITLEMENTS: ../build/entitlements.mac.plist

      # --- Verification before notarization ---
      - name: Verify all signatures
        run: |
          APP="release/mac-arm64/TestNotarize.app"
          echo "=== Checking main app signature ==="
          codesign -dvv "$APP" 2>&1

          echo ""
          echo "=== Verifying full bundle (strict) ==="
          codesign --verify --deep --strict --verbose=2 "$APP" 2>&1

          echo ""
          echo "=== Checking every Mach-O binary ==="
          FAIL=0
          while IFS= read -r binary; do
            # Check if it's a Mach-O file
            if file -b "$binary" | grep -q "Mach-O"; then
              if ! codesign --verify --strict --verbose=0 "$binary" 2>/dev/null; then
                echo "FAIL: $binary"
                codesign -dvv "$binary" 2>&1 || true
                FAIL=1
              else
                # Show signing authority for debugging
                AUTHORITY=$(codesign -dvv "$binary" 2>&1 | grep "Authority=" | head -1 || true)
                echo "OK: $(echo "$binary" | sed "s|.*\.app/||") — $AUTHORITY"
              fi
            fi
          done < <(find "$APP" -type f -perm +111 2>/dev/null)

          # Also check .dylib and .node files (may not have +111 permissions)
          while IFS= read -r binary; do
            if ! codesign --verify --strict --verbose=0 "$binary" 2>/dev/null; then
              echo "FAIL: $binary"
              codesign -dvv "$binary" 2>&1 || true
              FAIL=1
            else
              AUTHORITY=$(codesign -dvv "$binary" 2>&1 | grep "Authority=" | head -1 || true)
              echo "OK: $(echo "$binary" | sed "s|.*\.app/||") — $AUTHORITY"
            fi
          done < <(find "$APP" -type f \( -name "*.dylib" -o -name "*.node" -o -name "*.so" \) 2>/dev/null)

          if [ "$FAIL" -eq 1 ]; then
            echo "::error::Some binaries failed signature verification"
            exit 1
          fi

          echo ""
          echo "=== All signatures verified ==="

      # --- Notarization via explicit notarytool ---
      - name: Notarize
        timeout-minutes: 30
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP="release/mac-arm64/TestNotarize.app"

          echo "::group::Zip app for notarization"
          ditto -c -k --keepParent "$APP" release/TestNotarize.app.zip
          echo "Zip size: $(du -h release/TestNotarize.app.zip | cut -f1)"
          echo "::endgroup::"

          echo "::group::Submit to Apple notary service"
          xcrun notarytool submit release/TestNotarize.app.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait --timeout 20m \
            --verbose
          echo "::endgroup::"

          echo "::group::Staple notarization ticket"
          xcrun stapler staple "$APP"
          echo "::endgroup::"

          echo "::group::Verify after stapling"
          spctl --assess --type execute --verbose=2 "$APP"
          echo "::endgroup::"

      - name: List output
        if: always()
        run: ls -lh release/ 2>/dev/null || true

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-notarize
          path: |
            test-notarize/release/*.dmg
            test-notarize/release/*.zip
          retention-days: 1
